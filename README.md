# LinuxFileSystemSimulating

本设计的目的是实现操作系统和相关系统软件的设计，其中涉及进程编程、线程编程、I/O操作、存储管理、文件系统等操作系统概念。  
将一个大文件作为虚拟磁盘，在其上实现模拟的Linux文件系统，包括i节点、目录、文件、用户权限等的设计  

[设计](#设计)  
[相关操作算法](#相关操作算法)  
[IPC算法](#ipc算法)  
[用户命令手册](#用户命令)  

## 设计
（1）在本设计中，为常用的基本类型取了别名，以区别其用途：  
using ull = unsigned long long; //长整型  
using tInodeID = unsigned short; //i节点编号  
using tBlockID = unsigned int; //块编号  
using tFileSize = unsigned int; //文件大小  
using tUid = unsigned char; //用户编号  
（2）i节点设计：  
	Inode { //总大小64B  
		std::bitset<32> bits; //包含读写权限、使用位等标志位  
		tUid uid; //所有者的用户编号  
		tLinkCnt linkCnt; //引用计数，实际没有使用  
		tFileSize filesize; //文件大小  
		tBlockID blockCnt; //文件占用的块数量  
		tBlockID blockX1[10]; //文件的前十块（直接块号）  
		tBlockID blockX2; //一级间接块的块号  
		tBlockID blockX3; //二级间接块的块号  
	};  
（3）文件设计：  
File {  
		Inode* inode; //文件对应的i节点  
		std::vector<tBlockID> blockIDList; //文件的块号列表  
		std::vector<char> data; //文件的实际内容  
	};  
（4）目录项设计：  
DirEntry { //总大小128B  
		bool UsedFlag; //使用标志位  
		bool dirFlag; //目录标志位  
		tInodeID inodeID; //对应i节点号  
		char filename[NAME_BUF_LENGTH]; //文件名  
	};  
（5）目录设计：  
目录被设计为特殊的文件，通过将文件内容解释为目录项（DirEntry），在内存中维持文件名到目录项的映射，实现在目录下按名索引文件。  
Directory {  
		std::unordered_map<std::string, DirEntry> list;  
		File* dfile;  
	};  
（6）超级块设计：  
SBlock { //填充至1024B以对齐块大小  
		ull testNum; //幻数，仅当其为重复的10字节串时表示虚拟磁盘已被格式化  
		ull inodeBitsetPos; //i节点位图地址  
		ull blockBitsetPos; //块位图地址  
		tInodeID freeInodePointer; //空闲i节点指针   
		tBlockID freeBlockPointer; //空闲块指针  
		ull freeInodeCnt; //空闲的i节点计数  
		ull freeBlockCnt; //空闲的块计数  
		ull inodeSize; //i节点总数  
		ull blockSize; //块总数  
		ull firstInodePos; //i节点基址  
		ull firstBlockPos; //块基址  
		tInodeID rootInode; //根目录i节点号  
	};  
  
 ## 相关操作算法
* 初始化：当读入虚拟磁盘时，检查其是否以设置的幻数开头，若不是，则表明虚拟磁盘未格式化，执行格式化程序。
* 格式化：将超级块的初始内容写入磁盘，例如空闲指针、根目录i节点号等，并将位图和i节点初始化，设置幻数。
* 获取可用的i节点或块编号：时钟算法，测试空闲所指向的i节点或块是否可用，若可用则返回，并设置其已被占用，否则指针向前移动，当指针移动到原位置时，表示i节点或块已耗尽，抛出对应的异常。
* 获取i节点或块：超级块中有i节点和块的基址，通过其编号和大小可以计算偏移量，从而在对应的位置取出i节点或块。
* 文件：在文件系统中维持了一个i节点号到已被打开的文件的哈希表，其他代码获取的文件都是表中文件的引用，这样就保证了文件的一致性。
* 目录：目录是一个临时结构，通过打开对应的目录文件，将其中的内容解释为一个个的目录项，并维持一个文件名到目录项的哈希表，实现在目录下的按名索引。
* 打开目录或文件：以“/”开始的路径被视为绝对路径，单独的“/”被解释为根目录。当需要打开目录或文件时，也同时会将上下文环境，即上一级目录传入，上下文环境默认为当前目录。当打开的路径有多级时，则递归打开，将打开的顶层目录作为上下文环境递归。
* 创建目录或文件：获取可用的i节点和块，写入数据，再打开对应的父目录，写入目录项；如果是新建目录的话，还需要写入自身目录项“.”及父目录项“..”。
* 删除文件：删除文件不需要覆盖文件块中的数据。先将块号列表中的块号全部释放，在块位图中标记其可用，再将无效的块号标记写回i节点，再释放i节点，并在其父目录下删除对应的目录项。
* 删除目录：目录是特殊的文件，删除目录基本上和删除文件类似。对无内容的目录可以直接删除（不能删除当前目录），对有内容的目录等待用户确认后，检查目录中的每一个目录项，若其是文件则直接删除，若其是目录则递归删除。
* 权限管理：文件（目录同理）的所有者和权限被记录在i节点中，当需要打开文件时，检查其操作和权限是否相应，否则不允许操作。文件系统中的根目录属于0号用户。
* 临界区：对于文件系统的写操作，都要求进入临界区操作，Windows系统会检查临界区是否可进，否则会挂起线程等待。对于simdisk中共享资源，如登录用户的集合，操作这些资源也需要进入相应的临界区以保证互斥。
* 互斥量：为了避免多个shell在登陆时产生竞争，要求在连接simdisk，即登录时写入共享存储区时要先对互斥量进行P操作，登录完毕后再对互斥量进行V操作。
* 一般的数据交互：在登录完成后，不需要再使用互斥量，使用simdisk回发的共享存储区名打开新的共享存储区，使用设计二中的机制进行同步通信。
* simdisk退出：当shell中的用户输入exit指令后，该shell程序会退出，同时simdisk中对应的线程也会终止。simdisk主程序中的循环由一个布尔值working控制，在每一个用户线程退出时，检查自身是否最后一个用户线程，若是则将working设置为false，主线程退出循环，进而进程退出。


## IPC算法
本设计使用的用于后台simdisk和前端shell程序同步的算法类似于严格轮转法。  
观察到后台和前端的通讯符合以下模式：①部分指令是一指令一输出；②部分指令没有输出；③newfile指令较为特殊，需要连续的用户输入。  
从以上模式中抽象得出，两个进程的通讯可用以下四个状态及其切换来表示：①simdisk等待shell输入，令其状态码为‘1’；②shell已发送命令，等待simdisk确认，令其状态码为‘c’；③simdisk已回复消息，等待shell确认，令其状态码为‘s’；④shell已确认消息，令其状态码为‘0’。
状态码被写入共享存储区的首位，作为控制进程同步的依据。故对于上述三个模式的通讯，各流程如下：①对于一指令一输出的情况，状态码初始化为‘0’，simdisk程序需要等待输入时，等待状态码为‘0’，是则将其设置为‘1’，表示等待输入；shell输入的指令在状态码为‘1’时直接写入共享存储区，否则等待，写入后将状态码设置为‘c’；simdisk在等待状态码变为‘c’，读入用户指令并处理，将输出写入共享存储区，再将状态码设置为‘s’；shell在等待状态码变为‘s’后，取出数据，输出到标准输入输出设备，将状态码设置为‘0’以表确认。②对于没有输出的指令，在处理完指令后，由simdisk直接将状态码由‘s’变为‘0’。③对于需要连续输入的newfile指令，simdisk在处理完来自shell的每一段输入都直接将状态码从‘c’设置为‘0’。  
为了减轻程序负担，上述的等待不使用忙等待，而是使进程休眠25ms再检测状态码。  
由于共享存储区是固定大小的（这里使用的是1024B），存在消息长度大于共享存储区大小的可能。于是设定共享存储区的第二位作为分段标志位，则单次写入共享存储区的信息长度最长为1022B。当接收方检测到分段标志位为‘1’时，不按照原流程设置状态码，而是设置状态码为其上一个状态，发送方等待这种状态变化后继续发送下一段数据，直到分段标志位为‘0’，表明消息结束。  

## 用户命令
下面的命令中，[]表示可选参数，<>表示必要参数
* info [-h]  
info输出文件系统状态信息，-h参数表示输出命令列表
* cd <dir_path>  
切换工作目录，路径可以是绝对路径或相对路径（以‘/’开头，单独的‘/’表示根目录
* chmod <file_path_name> <authority_string>  
修改权限，权限字符串类似“wr-r”表示所有者可读可写，其他用户可读不可写
* dir [dir_path] [-s]  
显示目录，dir_path默认为当前的工作目录，-s参数表示递归显示子目录内容
* md <new_dir_name> [parent_dir]  
创建目录，父目录默认为当前的工作目录
* rd <dir_path>  
删除目录
* newfile <filename> [parent_dir]  
创建文件
* cat <file_path_name>  
打开文件，作为文本输出
* copy <file_path_name> <dir>  
复制文件，两个参数都可以接受带有<host>开头的路径，表示host文件系统的路径和文件，单独的<host>表示simdisk所在的目录，不允许host到host的复制操作
* del <file_path_name>  
删除文件
* check  
检查i节点一致性并修正，并保存超级块、位图等内容
* exit  
退出

